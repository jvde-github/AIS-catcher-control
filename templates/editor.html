<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Configuration - AIS-catcher Control</title>
    <link href="/static/tailwind.min.css" rel="stylesheet">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // UDP Management Script (existing)
            const udpTableBody = document.getElementById("udp-table-body");
            const addUdpBtn = document.getElementById("add-udp-btn");
            const udpModal = document.getElementById("udp-modal");
            const udpForm = document.getElementById("udp-form");
            const closeModalBtn = document.getElementById("close-modal");
            const udpAction = document.getElementById("udp-action");
            const udpIndex = document.getElementById("udp-index");

            let udpData = [];
            let editingIndex = null;

            // Initialize UDP Data from JSON Content
            function initializeUdpData() {
                const jsonContent = document.getElementById("json_content").value;
                try {
                    const config = JSON.parse(jsonContent);
                    if (Array.isArray(config.udp)) {
                        udpData = config.udp;
                    } else {
                        udpData = [];
                    }
                } catch (e) {
                    console.error("Invalid JSON in config.json:", e);
                    udpData = [];
                }
                renderUdpTable();
            }

            // Render UDP Table
            function renderUdpTable() {
                udpTableBody.innerHTML = "";
                udpData.forEach((udp, index) => {
                    const row = document.createElement("tr");
                    row.classList.add("border-b", "hover:bg-gray-100");

                    // Active Status
                    const activeCell = document.createElement("td");
                    activeCell.classList.add("px-4", "py-2", "text-center");
                    const activeBadge = udp.active ? 
                        `<span class="inline-block px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Active</span>` :
                        `<span class="inline-block px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Inactive</span>`;
                    activeCell.innerHTML = activeBadge;
                    row.appendChild(activeCell);

                    // Host
                    const hostCell = document.createElement("td");
                    hostCell.classList.add("px-4", "py-2");
                    hostCell.textContent = udp.host || "-";
                    row.appendChild(hostCell);

                    // Port
                    const portCell = document.createElement("td");
                    portCell.classList.add("px-4", "py-2", "text-center");
                    portCell.textContent = udp.port || "-";
                    row.appendChild(portCell);

                    // JSON Output
                    const jsonCell = document.createElement("td");
                    jsonCell.classList.add("px-4", "py-2", "text-center");
                    jsonCell.textContent = udp.json !== undefined ? (udp.json ? "Yes" : "No") : "No";
                    row.appendChild(jsonCell);

                    // Actions
                    const actionsCell = document.createElement("td");
                    actionsCell.classList.add("px-4", "py-2", "text-center", "space-x-2");

                    // Edit Button with New Icon
                    const editBtn = document.createElement("button");
                    editBtn.setAttribute("aria-label", "Edit");
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368">
                                            <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/>
                                        </svg>`;
                    editBtn.classList.add("focus:outline-none");
                    editBtn.onclick = () => openUdpModal("edit", index);
                    actionsCell.appendChild(editBtn);

                    // Delete Button with Icon
                    const deleteBtn = document.createElement("button");
                    deleteBtn.setAttribute("aria-label", "Delete");
                    deleteBtn.innerHTML = `<svg class="w-5 h-5 text-red-500 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                         </svg>`;
                    deleteBtn.classList.add("focus:outline-none");
                    deleteBtn.onclick = () => deleteUdp(index);
                    actionsCell.appendChild(deleteBtn);

                    row.appendChild(actionsCell);

                    udpTableBody.appendChild(row);
                });
                updateJsonContent();
            }

            // Open UDP Modal for Add/Edit
            function openUdpModal(action, index = null) {
                udpModal.classList.remove("hidden");
                udpAction.value = action;
                udpIndex.value = index;

                if (action === "edit" && index !== null) {
                    const udp = udpData[index];
                    document.getElementById("udp-active").checked = udp.active !== undefined ? udp.active : true; // Set active by default
                    document.getElementById("udp-host").value = udp.host || "";
                    document.getElementById("udp-port").value = udp.port || "";
                    document.getElementById("udp-json").checked = udp.json !== undefined ? udp.json : false;
                } else {
                    udpForm.reset();
                    document.getElementById("udp-active").checked = true; // Active by default
                }
            }

            // Close UDP Modal
            function closeUdpModal() {
                udpModal.classList.add("hidden");
                udpForm.reset();
            }

            // Add or Update UDP Entry
            function submitUdpForm(event) {
                event.preventDefault();
                const action = udpAction.value;
                const index = udpIndex.value;

                const udpEntry = {
                    active: document.getElementById("udp-active").checked,
                    host: document.getElementById("udp-host").value.trim(),
                    port: document.getElementById("udp-port").value.trim(),
                    json: document.getElementById("udp-json").checked
                };

                // Basic Validation
                if (!udpEntry.host || !udpEntry.port) {
                    alert("Host and Port are required.");
                    return;
                }

                // Additional Validation: Port must be a number between 1 and 65535
                const portNumber = parseInt(udpEntry.port, 10);
                if (isNaN(portNumber) || portNumber < 1 || portNumber > 65535) {
                    alert("Port must be a number between 1 and 65535.");
                    return;
                }

                if (action === "add") {
                    udpData.push(udpEntry);
                } else if (action === "edit" && index !== null) {
                    // Perform a partial update to preserve unknown keys
                    udpData[index] = Object.assign({}, udpData[index], udpEntry);
                }

                renderUdpTable();
                closeUdpModal();
            }

            // Delete UDP Entry
            function deleteUdp(index) {
                if (confirm("Are you sure you want to delete this UDP entry?")) {
                    udpData.splice(index, 1);
                    renderUdpTable();
                }
            }

            // Update config.json Textarea
            function updateJsonContent() {
                const jsonContent = document.getElementById("json_content").value;
                try {
                    const config = JSON.parse(jsonContent);
                    config.udp = udpData;
                    document.getElementById("json_content").value = JSON.stringify(config, null, 4);
                } catch (e) {
                    console.error("Invalid JSON in config.json:", e);
                }
            }

            // Event Listeners
            addUdpBtn.addEventListener("click", () => openUdpModal("add"));
            closeModalBtn.addEventListener("click", closeUdpModal);
            udpForm.addEventListener("submit", submitUdpForm);

            // Initialize
            initializeUdpData();

            // Collapsible Sections Script
            const collapsibleHeaders = document.querySelectorAll(".collapsible-header");
            collapsibleHeaders.forEach(header => {
                header.addEventListener("click", () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector(".toggle-icon");

                    if (content.classList.contains("hidden")) {
                        content.classList.remove("hidden");
                        icon.innerHTML = `
                            <svg class="w-4 h-4 transform rotate-180 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>`;
                    } else {
                        content.classList.add("hidden");
                        icon.innerHTML = `
                            <svg class="w-4 h-4 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>`;
                    }
                });
            });
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">AIS-catcher Control Panel</h1>
            <div>
                <a href="/dashboard" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 flex-grow">
        <div class="bg-white shadow-md rounded-lg p-6">
            <!-- Success Message -->
            {{if .Message}}
            <div class="mb-6 p-4 bg-green-100 border border-green-300 text-green-800 rounded">
                {{.Message}}
            </div>
            {{end}}
            <!-- Error Message -->
            {{if .Error}}
            <div class="mb-6 p-4 bg-red-100 border border-red-300 text-red-800 rounded">
                {{.Error}}
            </div>
            {{end}}

            <!-- UDP Outputs Management (Expanded by Default) -->
            <div class="mb-8">
                <div class="collapsible-header flex justify-between items-center cursor-pointer mb-2">
                    <h2 class="text-xl font-semibold text-gray-700">UDP Output</h2>
                    <span class="toggle-icon">
                        <svg class="w-4 h-4 transform rotate-180 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
                <div class="collapsible-content">
                    <div class="flex justify-between items-center mb-4">
                        <button id="add-udp-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add UDP Output
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b bg-gray-100 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Active</th>
                                    <th class="py-2 px-4 border-b bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Host</th>
                                    <th class="py-2 px-4 border-b bg-gray-100 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Port</th>
                                    <th class="py-2 px-4 border-b bg-gray-100 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">JSON Output</th>
                                    <th class="py-2 px-4 border-b bg-gray-100 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="udp-table-body">
                                <!-- UDP Entries will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AIS-catcher Command Line Configuration (Collapsed by Default) -->
            <div class="mb-8">
                <div class="collapsible-header flex justify-between items-center cursor-pointer mb-2">
                    <h2 class="text-xl font-semibold text-gray-700">AIS-catcher Command Line Configuration</h2>
                    <span class="toggle-icon">
                        <svg class="w-4 h-4 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
                <div class="collapsible-content hidden">
                    <form method="post" class="space-y-8">
                        <!-- config.cmd Section -->
                        <div>
                            <textarea name="cmd_content" class="w-full h-40 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>{{.CmdContent}}</textarea>
                        </div>
                </div>
            </div>

            <!-- AIS-catcher JSON Configuration (Collapsed by Default) -->
            <div class="mb-8">
                <div class="collapsible-header flex justify-between items-center cursor-pointer mb-2">
                    <h2 class="text-xl font-semibold text-gray-700">AIS-catcher JSON Configuration</h2>
                    <span class="toggle-icon">
                        <svg class="w-4 h-4 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
                <div class="collapsible-content hidden">
                        <!-- config.json Section -->
                        <div>
                            <textarea id="json_content" name="json_content" class="w-full h-64 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" readonly>{{.JsonContent}}</textarea>
                        </div>
                        
                        <!-- Submit Button -->
                        <div>
                            <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-200" type="submit">
                                Save Configuration
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Dashboard Button -->
    <div class="container mx-auto px-4 pb-4">
        <a href="/dashboard" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-200">
            Back to Dashboard
        </a>
    </div>

    <!-- UDP Modal (Remains the Same) -->
    <div id="udp-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-96">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-700" id="modal-title">Add UDP Output</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="udp-form" class="p-4">
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="udp-active" class="form-checkbox h-5 w-5 text-green-600 mr-2" checked>
                    <label for="udp-active" class="text-gray-700">Active</label>
                </div>
                <div class="mb-4">
                    <label for="udp-host" class="block text-gray-700 mb-2">Host</label>
                    <input type="text" id="udp-host" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-4">
                    <label for="udp-port" class="block text-gray-700 mb-2">Port</label>
                    <input type="number" id="udp-port" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" min="1" max="65535" required>
                </div>
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="udp-json" class="form-checkbox h-5 w-5 text-purple-600 mr-2">
                    <label for="udp-json" class="text-gray-700">JSON Output</label>
                </div>
                <!-- Hidden Fields -->
                <input type="hidden" id="udp-action" value="">
                <input type="hidden" id="udp-index" value="">
                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
