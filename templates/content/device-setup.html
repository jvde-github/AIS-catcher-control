{{ define "device-setup" }}
<div id="device-setup" class="p-6 bg-white shadow-md rounded-lg max-w-2xl mx-auto">
    <div class="border-b border-gray-200" role="tablist">
        <!-- Change from flex to grid for small screens -->
        <div class="grid grid-cols-2 gap-2 sm:flex sm:-mb-px sm:space-x-4">
            <button role="tab" aria-selected="true" data-tab="rtlsdr"
                class="py-2 px-4 text-sm sm:text-base text-gray-700 font-medium border-b-2 border-yellow-500 hover:text-gray-900 transition-colors truncate">RTLSDR</button>
            <button role="tab" aria-selected="false" data-tab="airspyhf"
                class="py-2 px-4 text-sm sm:text-base text-gray-500 font-medium border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-colors truncate">Airspy
                HF+</button>
            <button role="tab" aria-selected="false" data-tab="rtltcp"
                class="py-2 px-4 text-sm sm:text-base text-gray-500 font-medium border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-colors truncate">TCP</button>
            <button role="tab" aria-selected="false" data-tab="udpserver"
                class="py-2 px-4 text-sm sm:text-base text-gray-500 font-medium border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-colors truncate">UDP
            </button>
            <button role="tab" aria-selected="false" data-tab="serialport"
                class="py-2 px-4 text-sm sm:text-base text-gray-500 font-medium border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-colors truncate">Serial
            </button>
        </div>
    </div>

    <div role="tabpanel" id="rtlsdr-panel" class="mt-6">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">RTLSDR</h3>
        <form id="rtlsdr-form" class="space-y-6">
            <div class="max-w-md">
                <label for="rtlsdr-tuner" class="block text-gray-700 font-medium mb-2">Tuner:</label>
                <select id="rtlsdr-tuner" name="tuner" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="auto">Auto</option>
                    {{range $i := seq 0 50}}
                    <option value="{{$i}}">{{$i}}</option>
                    {{end}}
                </select>
            </div>

            <div class="max-w-md">
                <label for="rtlsdr-bandwidth" class="block text-gray-700 font-medium mb-2">Bandwidth:</label>
                <select id="rtlsdr-bandwidth" name="bandwidth"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="0">Off</option>
                    <option value="192K">192K</option>
                </select>
            </div>

            <div class="max-w-md">
                <label for="rtlsdr-sample-rate" class="block text-gray-700 font-medium mb-2">Sample Rate:</label>
                <select id="rtlsdr-sample-rate" name="sample_rate"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="288K">288K</option>
                    <option value="1536K" selected>1536K</option>
                </select>
            </div>

            <div class="flex items-center justify-between max-w-md">
                <div class="flex items-center mb-6">
                    <label for="biastee-toggle" class="text-gray-700 font-medium">Bias tee:</label>
                    <label class="ml-4 relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="biastee-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-500 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white 
                            after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full 
                            after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-yellow-500">
                        </div>
                    </label>
                </div>
            </div>

            <div class="flex items-center justify-between max-w-md">
                <div class="flex items-center mb-6">
                    <label for="rtlagc-toggle" class="text-gray-700 font-medium">RTLAGC:</label>
                    <label class="ml-4 relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="rtlagc-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-500 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white 
                            after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full 
                            after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-yellow-500">
                        </div>
                    </label>
                </div>
            </div>
            <!-- Frequency Offset -->
            <div class="max-w-md">
                <label for="rtlsdr-freqoffset" class="block text-gray-700 font-medium mb-2">Frequency Offset:</label>
                <input type="number" id="rtlsdr-freqoffset" name="freqoffset" min="-50" max="50" value="0"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
            </div>
        </form>
    </div>

    <div role="tabpanel" id="airspyhf-panel" class="mt-6 hidden">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Airspy HF+</h3>
        <form id="airspyhf-form" class="space-y-6">
            <div class="max-w-md">
                <label for="airspyhf-sample-rate" class="block text-gray-700 font-medium mb-2">Sample Rate:</label>
                <select id="airspyhf-sample-rate" name="sample_rate"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="192K">192K</option>
                </select>
            </div>

            <div class="max-w-md">
                <label for="airspyhf-threshold" class="block text-gray-700 font-medium mb-2">Threshold:</label>
                <select id="airspyhf-threshold" name="threshold"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="low" selected>Low</option>
                    <option value="high">High</option>
                </select>
            </div>

            <div class="flex items-center justify-between max-w-md">
                <div class="flex items-center mb-6">
                    <label for="preamp-toggle" class="text-gray-700 font-medium">Preamp:</label>
                    <label class="ml-4 relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="preamp-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-500 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white 
                            after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full 
                            after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-yellow-500">
                        </div>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <div role="tabpanel" id="rtltcp-panel" class="mt-6 hidden">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">TCP</h3>
        <form id="rtltcp-form" class="space-y-6">
            <div class="max-w-md">
                <label for="rtltcp-protocol" class="block text-gray-700 font-medium mb-2">Protocol:</label>
                <select id="rtltcp-protocol" name="protocol" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="none">None</option>
                    <option value="txt">TXT</option>
                </select>
            </div>

            <div class="max-w-md">
                <label for="rtltcp-host" class="block text-gray-700 font-medium mb-2">Host:</label>
                <input type="text" id="rtltcp-host" name="host"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="e.g., 127.0.0.1">
            </div>

            <div class="max-w-md">
                <label for="rtltcp-port" class="block text-gray-700 font-medium mb-2">Port:</label>
                <input type="number" id="rtltcp-port" name="port"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="e.g., 1234">
            </div>

            <div class="max-w-md">
                <label for="rtltcp-sample-rate" class="block text-gray-700 font-medium mb-2">Sample Rate:</label>
                <select id="rtltcp-sample-rate" name="sample_rate"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="288K">288K</option>
                    <option value="1536K">1536K</option>
                </select>
            </div>

            <div class="max-w-md">
                <label for="rtltcp-bandwidth" class="block text-gray-700 font-medium mb-2">Bandwidth:</label>
                <select id="rtltcp-bandwidth" name="bandwidth"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="0">Off</option>
                    <option value="192K">192K</option>
                </select>
            </div>

            <div class="flex items-center justify-between max-w-md">
                <div class="flex items-center mb-6">
                    <label for="rtltcp-rtlagc-toggle" class="text-gray-700 font-medium">RTLAGC:</label>
                    <label class="ml-4 relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="rtltcp-rtlagc-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-500 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white 
                            after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full 
                            after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-yellow-500">
                        </div>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <div role="tabpanel" id="udpserver-panel" class="mt-6 hidden">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">UDP Server</h3>
        <form id="udpserver-form" class="space-y-6">
            <div class="max-w-md">
                <label for="udpserver-address" class="block text-gray-700 font-medium mb-2">Server Address:</label>
                <input type="text" id="udpserver-address" name="address"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="e.g., 127.0.0.1">
            </div>

            <div class="max-w-md">
                <label for="udpserver-port" class="block text-gray-700 font-medium mb-2">Port:</label>
                <input type="number" id="udpserver-port" name="port"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="e.g., 1234">
            </div>
        </form>
    </div>

    <!-- New Serial Port panel -->
    <div role="tabpanel" id="serialport-panel" class="mt-6 hidden">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Serial Port</h3>
        <form id="serialport-form" class="space-y-6">
            <div class="max-w-md">
                <label for="serialport-port" class="block text-gray-700 font-medium mb-2">Port:</label>
                <div class="flex gap-2">
                    <input type="text" id="serialport-port" name="port"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-md" placeholder="e.g., /dev/tty0"
                        value="">
                    <button type="button" onclick="openSerialDeviceModal()"
                        class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                        Get
                    </button>
                </div>
            </div>

            <div class="max-w-md">
                <label for="serialport-baudrate" class="block text-gray-700 font-medium mb-2">Baud Rate:</label>
                <select id="serialport-baudrate" name="baudrate"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    <option value="9600">9600</option>
                    <option value="19200">19200</option>
                    <option value="38400" selected>38400</option>
                    <option value="57600">57600</option>
                    <option value="115200">115200</option>
                </select>
            </div>
        </form>
    </div>

    <div class="flex justify-end mt-6">
        <button id="save-button"
            class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors w-auto">Save</button>
    </div>

    <hr class="my-6 border-gray-300">

    <div class="mt-6">
        <button type="button" onclick="toggleJsonContent()" class="flex items-center text-gray-800 focus:outline-none">
            <svg id="chevron-icon" class="h-5 w-5 transform transition-transform duration-200"
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            <span class="ml-2 font-medium">Show JSON Content</span>
        </button>

        <div id="json-content-container" class="mt-2 hidden">
            <pre id="json_content" name="json_content"
                class="max-w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 overflow-auto focus:outline-none focus:ring-2 focus:ring-yellow-500"
                readonly>{{.JsonContent}}</pre>
        </div>
    </div>
</div>

<div id="serial-device-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl mx-4">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-medium text-gray-800">Select Serial Device</h3>
            <button type="button" onclick="closeSerialDeviceModal()" class="text-gray-600 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4">
            <ul id="serial-device-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Devices will be populated here -->
            </ul>
        </div>
        <div class="flex justify-end p-4 border-t">
            <button type="button" onclick="closeSerialDeviceModal()"
                class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200">
                Close
            </button>
        </div>
    </div>
</div>

<style>
    input:disabled,
    select:disabled {
        background-color: #f9f9f9;
        color: #a0aec0;
        cursor: not-allowed;
    }

    .peer:disabled~div {
        opacity: 0.5;
        cursor: not-allowed;
    }

    label[for]:disabled {
        color: #a0aec0;
    }

    @media (max-width: 640px) {
        #device-setup {
            padding: 1rem;
        }
    }
</style>

<script>

    const formToJsonMap = {
        "rtlsdr-bandwidth": "rtlsdr.bandwidth",
        "rtlsdr-sample-rate": "rtlsdr.sample_rate",
        "rtlsdr-tuner": "rtlsdr.tuner",
        "rtlsdr-freqoffset": "rtlsdr.freqoffset",
        "biastee-toggle": "rtlsdr.biastee",
        "rtlagc-toggle": "rtlsdr.rtlagc",
        "airspyhf-sample-rate": "airspyhf.sample_rate",
        "airspyhf-threshold": "airspyhf.threshold",
        "preamp-toggle": "airspyhf.preamp",
        // RTLTCP mappings
        "rtltcp-host": "rtltcp.host",
        "rtltcp-port": "rtltcp.port",
        "rtltcp-protocol": "rtltcp.protocol",
        "rtltcp-sample-rate": "rtltcp.sample_rate",
        "rtltcp-bandwidth": "rtltcp.bandwidth",
        "rtltcp-rtlagc-toggle": "rtltcp.rtlagc",
        "udpserver-address": "udpserver.address",
        "udpserver-port": "udpserver.port",
        "serialport-port": "serialport.port",
        "serialport-baudrate": "serialport.baudrate",
    };

    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('[role="tab"]');
        const panels = document.querySelectorAll('[role="tabpanel"]');

        // Tab switching logic
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Deselect all tabs and hide all panels
                tabs.forEach(t => {
                    t.setAttribute('aria-selected', 'false');
                    t.classList.remove('text-gray-700', 'border-yellow-500');
                    t.classList.add('text-gray-500', 'border-transparent');
                });

                panels.forEach(panel => {
                    panel.classList.add('hidden');
                });

                // Select the clicked tab and show the corresponding panel
                tab.setAttribute('aria-selected', 'true');
                tab.classList.remove('text-gray-500', 'border-transparent');
                tab.classList.add('text-gray-700', 'border-yellow-500');
                document.getElementById(`${tab.dataset.tab}-panel`).classList.remove('hidden');
            });
        });

        // Handle switch toggles
        document.querySelectorAll('[role="switch"]').forEach(toggle => {
            toggle.addEventListener('click', function () {
                const isChecked = this.getAttribute('aria-checked') === 'true';
                this.setAttribute('aria-checked', !isChecked);
                this.classList.toggle('bg-yellow-500', !isChecked);
                const knob = this.querySelector('span');
                knob.style.transform = !isChecked ? 'translateX(1.5rem)' : 'translateX(0.25rem)';
            });
        });

        // Function to update RTLTCP fields based on protocol
        function updateRTLTCPFields() {
            const protocol = document.getElementById('rtltcp-protocol').value;
            const hostField = document.getElementById('rtltcp-host');
            const portField = document.getElementById('rtltcp-port');
            const otherFields = [
                document.getElementById('rtltcp-sample-rate'),
                document.getElementById('rtltcp-bandwidth'),
                document.getElementById('rtltcp-rtlagc-toggle'),
            ];

            if (protocol === 'txt') {
                // Enable host and port fields
                hostField.disabled = false;
                portField.disabled = false;
                // Disable other fields
                otherFields.forEach(field => field.disabled = true);
            } else {
                // Disable host and port fields
                hostField.disabled = true;
                portField.disabled = true;
                // Enable other fields
                otherFields.forEach(field => field.disabled = false);
            }
        }

        updateRTLTCPFields();

        document.getElementById('rtltcp-protocol').addEventListener('change', updateRTLTCPFields);

    });

    function openSerialDeviceModal() {
        fetchSerialDevices();
        document.getElementById('serial-device-modal').classList.remove('hidden');
    }

    function closeSerialDeviceModal() {
        document.getElementById('serial-device-modal').classList.add('hidden');
    }

    function selectSerialDevice(device) {
        document.getElementById('serialport-port').value = device;
        closeSerialDeviceModal();
    }

    function fetchSerialDevices() {
        fetch('/serial-list')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('serial-device-list');
                list.innerHTML = '';

                const devices = data.devices || [];

                if (devices.length === 0) {
                    list.innerHTML = '<li class="text-gray-500 p-2">No devices found</li>';
                    return;
                }

                devices.forEach(device => {
                    const li = document.createElement('li');
                    li.className = 'p-2 hover:bg-gray-100 cursor-pointer rounded';
                    li.onclick = () => selectSerialDevice(device);
                    li.textContent = device;
                    list.appendChild(li);
                });
            })
            .catch(error => {
                console.error('Error fetching serial devices:', error);
                const list = document.getElementById('serial-device-list');
                list.innerHTML = '<li class="text-red-500 p-2">Error loading devices</li>';
            });
    }
</script>
{{ end }}