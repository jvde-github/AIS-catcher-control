{{ define "device-setup" }}
<div id="device-setup" class="max-w-2xl mx-auto p-4 md:p-6 bg-white rounded-lg shadow-md">
    <h3 class="text-lg text-xl font-semibold text-gray-800 mb-4">Device Configuration</h3>

    <div id="receivers-container" class="space-y-6">
        <!-- Receivers will be dynamically populated here -->
    </div>
</div>

<!-- Modals remain the same -->
<div id="serial-device-modal" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center hidden z-50" style="background-color: rgba(0, 0, 0, 0.3);">
    <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl mx-4 relative z-10" style="background-color: white;">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-medium text-gray-800">Select Serial Device</h3>
            <button type="button" onclick="closeSerialDeviceModal()" class="text-gray-600 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4">
            <ul id="serial-device-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Devices will be populated here -->
            </ul>
        </div>
        <div class="flex justify-end p-4 border-t">
            <button type="button" onclick="closeSerialDeviceModal()"
                class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200">
                Close
            </button>
        </div>
    </div>
</div>

<div id="device-selection-modal"
    class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center hidden z-50" style="background-color: rgba(0, 0, 0, 0.3);">
    <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl mx-4 relative z-10" style="background-color: white;">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-medium text-gray-800">Select Device</h3>
            <button type="button" onclick="closeDeviceSelectionModal()" class="text-gray-600 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4">
            <ul id="device-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Devices will be populated here via JavaScript -->
            </ul>
        </div>
        <div class="flex justify-end p-4 border-t">
            <button type="button" onclick="closeDeviceSelectionModal()"
                class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    // Initialize receiver manager
    let receiverManager;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Enhance receiverSchema with device selection modal before initializing
        receiverSchema.input.withButton.onClick = (index) => openDeviceSelectionModal(index);
        
        receiverManager = createChannelManager({
            channelType: 'receiver',
            schema: receiverSchema,
            containerId: 'receivers-container',
            addButtonId: 'add-device-btn',
            saveButtonId: 'save-button',
            title: 'Receiver'
        });
    });

    // Modal and utility functions

    window.openSerialDeviceModal = function() {
        fetchSerialDevices();
        document.getElementById('serial-device-modal').classList.remove('hidden');
    };

    function closeSerialDeviceModal() {
        document.getElementById('serial-device-modal').classList.add('hidden');
    }

    function selectSerialDevice(device) {
        // Find the serial port input field by data-field attribute
        const input = document.querySelector('[data-field="serialport_port"] input');
        if (input) {
            input.value = device;
            // Trigger change event to update the config
            const event = new Event('change', { bubbles: true });
            input.dispatchEvent(event);
            const inputEvent = new Event('input', { bubbles: true });
            input.dispatchEvent(inputEvent);
            
            // Manually trigger the config manager update
            if (receiverManager && receiverManager.data && receiverManager.data.length > 0) {
                const receiver = receiverManager.data[0];
                if (!receiver.serialport) receiver.serialport = {};
                receiver.serialport.port = device;
                receiverManager.updateJsonDebug();
            }
        }
        closeSerialDeviceModal();
    }

    function fetchSerialDevices() {
        fetch('/serial-list')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('serial-device-list');
                list.innerHTML = '';

                const devices = data && Array.isArray(data) ? data : [];

                if (devices.length === 0) {
                    list.innerHTML = '<li class="text-gray-500 p-2">No devices found</li>';
                    return;
                }

                devices.forEach(device => {
                    const li = document.createElement('li');
                    li.className = 'p-2 hover:bg-gray-100 cursor-pointer rounded';
                    li.onclick = () => selectSerialDevice(device);
                    li.textContent = device;
                    list.appendChild(li);
                });
            })
            .catch(error => {
                console.error('Error fetching serial devices:', error);
                const list = document.getElementById('serial-device-list');
                list.innerHTML = '<li class="text-red-500 p-2">Error loading devices</li>';
            });
    }

    window.openDeviceSelectionModal = function(receiverIndex) {
        document.getElementById('device-selection-modal').classList.remove('hidden');
        fetchDeviceList();
    };

    function closeDeviceSelectionModal() {
        document.getElementById('device-selection-modal').classList.add('hidden');
    }

    function fetchDeviceList() {
        const deviceList = document.getElementById('device-list');
        fetch('/device-list')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch device list.');
                }
                return response.json();
            })
            .then(data => {
                populateDeviceList(data.devices);
            })
            .catch(error => {
                console.error('Error fetching device list:', error);
                deviceList.innerHTML = `<li class="text-red-500">Error fetching device list.</li>`;
            });
    }

    function populateDeviceList(devices) {
        const deviceList = document.getElementById('device-list');
        deviceList.innerHTML = '';

        if (!Array.isArray(devices) || devices.length === 0) {
            deviceList.innerHTML = `<li class="text-gray-500">No devices found.</li>`;
            return;
        }

        devices.forEach(device => {
            const listItem = document.createElement('li');
            listItem.className = 'flex items-center justify-between p-2 border rounded-md hover:bg-gray-100 cursor-pointer';
            listItem.innerHTML = `
        <span>${device.name}</span>
        <button type="button" class="select-device-btn bg-gray-600 text-white px-2 py-1 rounded-md hover:bg-gray-700">Select</button>
      `;

            listItem.querySelector('.select-device-btn').addEventListener('click', () => {
                selectDevice(device);
                closeDeviceSelectionModal();
            });

            deviceList.appendChild(listItem);
        });
    }

    function selectDevice(device) {
        if (!device || typeof device !== 'object') {
            console.error('Invalid device selected:', device);
            return;
        }

        // Find the input field by data-field attribute
        const inputField = document.querySelector('[data-field="input"] select');
        const serialField = document.querySelector('[data-field="serial"] input');

        if (inputField) {
            inputField.value = device.input.toUpperCase() || '';
            inputField.dispatchEvent(new Event('change', { bubbles: true }));
        }
        
        if (serialField) {
            serialField.value = device.serial || '';
            serialField.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Manually update the receiver manager data
        if (receiverManager && receiverManager.data && receiverManager.data.length > 0) {
            const receiver = receiverManager.data[0];
            receiver.input = device.input.toUpperCase() || '';
            receiver.serial = device.serial || '';
            receiverManager.updateJsonDebug();
        }
    }

</script>
{{ end }}