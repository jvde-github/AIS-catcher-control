{{ define "control" }}
<div class="space-y-6">
    <!-- Custom Styles -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 0.5rem;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .log-line {
            font-family: 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            padding: 1px 0;
            white-space: pre;
        }

        .log-line.error {
            color: #f87171;
        }

        .log-line.warning {
            color: #fbbf24;
        }

        .log-line.info {
            color: #60a5fa;
        }

        .log-line.default {
            color: #cbd5e1;
        }
    </style>

    <!-- Unified Service Control Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <!-- Header with Status -->
        <div class="px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="font-semibold text-slate-800 text-lg">Service Control</h2>
            </div>
            <div id="service-status-indicator" class="flex items-center space-x-2">
                <span id="service-status" class="text-sm font-medium text-slate-600">Checking...</span>
                <span class="relative flex h-2.5 w-2.5">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-500"></span>
                </span>
            </div>
        </div>

        <!-- Body with Status Info and Controls -->
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Uptime -->
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 font-medium">Uptime</p>
                        <p id="service-uptime" class="text-sm font-semibold text-slate-800 font-mono">--:--:--</p>
                    </div>
                </div>

                <!-- Auto-Start Status -->
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 font-medium">Start at Boot</p>
                        <p id="enabled-status" class="text-sm font-semibold text-slate-800">
                            <span class="inline-block h-4 w-16 bg-slate-100 rounded animate-pulse"></span>
                        </p>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex items-center justify-end space-x-2">
                    <div id="action-buttons" class="flex space-x-2 w-full md:w-auto">
                        <div class="h-9 flex-1 bg-slate-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Auto-Start Toggle -->
            <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                <span class="text-sm text-slate-600">Auto-start configuration</span>
                <div class="flex space-x-2">
                    <button id="enable-button" data-action="enable"
                        class="hidden px-4 py-1.5 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors action-button">
                        Enable
                    </button>
                    <button id="disable-button" data-action="disable"
                        class="hidden px-4 py-1.5 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 text-sm font-medium rounded-lg transition-colors action-button">
                        Disable
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Logs Section -->
    <div class="bg-slate-900 rounded-none sm:rounded-xl shadow-lg overflow-hidden border-x-0 sm:border-x border border-slate-700 flex flex-col">
        <div class="flex items-center justify-between px-4 py-2 bg-slate-800 border-b border-slate-700">
            <div class="flex items-center space-x-3 flex-1">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3"></path>
                </svg>
                <select id="log-source-select" onchange="switchLogSource()" class="bg-slate-700 text-slate-200 text-xs px-2 py-1 rounded border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="ais-catcher">ais-catcher</option>
                    <option value="control">control panel</option>
                    <option value="system">system</option>
                </select>
                <select id="log-priority-select" onchange="switchLogSource()" class="bg-slate-700 text-slate-200 text-xs px-2 py-1 rounded border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="debug">debug</option>
                    <option value="info" selected>info</option>
                    <option value="notice">notice</option>
                    <option value="warning">warning</option>
                    <option value="err">error</option>
                    <option value="crit">critical</option>
                </select>
            </div>
            <div class="flex space-x-1.5">
                <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
        </div>

        <div id="logs-container" class="h-64 sm:h-80 overflow-auto custom-scrollbar p-4 bg-slate-900">
            <div id="logs-content" class="flex flex-col justify-end min-h-full">
                {{if or .LogTxtLogs .Logs}}
                {{range .LogTxtLogs}}<div class="log-line default">{{.}}</div>{{end}}
                {{range .Logs}}<div class="log-line default">{{.}}</div>{{end}}
                {{else}}
                <div class="text-slate-500 italic text-sm">Waiting for logs...</div>
                {{end}}
            </div>
        </div>
    </div>

    <script>
        let operationInProgress = false;

        function getStatusIndicatorHTML(color) {
            return `
                <span class="relative flex h-2.5 w-2.5 ml-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-${color}-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-${color}-500"></span>
                </span>`;
        }

        function getStaticIndicatorHTML(color) {
            return `<span class="relative inline-flex rounded-full h-2.5 w-2.5 ml-2 bg-${color}-500"></span>`;
        }

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // --- Update Auto-Start (UPDATED: Plain text styling) ---
                    const enabledStatusDiv = document.getElementById('enabled-status');
                    const enableBtn = document.getElementById('enable-button');
                    const disableBtn = document.getElementById('disable-button');

                    if (data.enabled === true) {
                        // Matches "Active" style (Green text)
                        enabledStatusDiv.innerHTML = '<span class="text-emerald-600">Enabled</span>';
                        enableBtn.classList.add('hidden');
                        disableBtn.classList.remove('hidden');
                    } else if (data.enabled === false) {
                        // Matches "Stopped" style (Grey text)
                        enabledStatusDiv.innerHTML = '<span class="text-slate-500">Disabled</span>';
                        enableBtn.classList.remove('hidden');
                        disableBtn.classList.add('hidden');
                    } else {
                        enabledStatusDiv.innerHTML = '<span class="text-amber-600">Unknown</span>';
                    }

                    // --- Update Service Status ---
                    const indicatorContainer = document.getElementById('service-status-indicator');

                    if (data.status === 'active (running)') {
                        indicatorContainer.innerHTML = '<span class="text-sm font-medium text-emerald-600">Active</span>' + getStatusIndicatorHTML('emerald');
                    } else if (data.status === 'inactive (stopped)') {
                        indicatorContainer.innerHTML = '<span class="text-sm font-medium text-slate-600">Stopped</span>' + getStaticIndicatorHTML('slate');
                    } else if (data.status === 'failed') {
                        indicatorContainer.innerHTML = '<span class="text-sm font-medium text-rose-600">Failed</span>' + getStaticIndicatorHTML('rose');
                    } else {
                        indicatorContainer.innerHTML = `<span class="text-sm font-medium text-amber-600 capitalize">${data.status}</span>` + getStaticIndicatorHTML('amber');
                    }

                    // --- Update Uptime ---
                    document.getElementById('service-uptime').textContent = data.uptime;

                    // --- Update Action Buttons ---
                    const actionButtonsDiv = document.getElementById('action-buttons');
                    let buttonsHTML = '';

                    const btnBase = "px-4 py-2 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1";
                    const disabledClass = operationInProgress ? "opacity-50 cursor-not-allowed" : "";
                    const disabledAttr = operationInProgress ? "disabled" : "";
                    const primaryBtn = `${btnBase} ${disabledClass} text-white bg-slate-800 hover:bg-slate-700 focus:ring-slate-500`;
                    const dangerBtn = `${btnBase} ${disabledClass} text-white bg-rose-600 hover:bg-rose-700 focus:ring-rose-500`;
                    const secondaryBtn = `${btnBase} ${disabledClass} border border-slate-300 text-slate-700 bg-white hover:bg-slate-50 focus:ring-slate-500`;

                    if (data.status === 'active (running)') {
                        buttonsHTML += `<button class="${secondaryBtn} action-button" data-action="restart" ${disabledAttr}>Restart</button>`;
                        buttonsHTML += `<button class="${dangerBtn} action-button" data-action="stop" ${disabledAttr}>Stop</button>`;
                    } else {
                        buttonsHTML += `<button class="${primaryBtn} action-button" data-action="start" ${disabledAttr}>Start Service</button>`;
                    }
                    actionButtonsDiv.innerHTML = buttonsHTML;
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            let eventSource = null;
            let currentLogSource = 'ais-catcher';
            let currentPriority = 'info';

            updateStatus();
            setInterval(updateStatus, 3000);

            // Switch log source
            window.switchLogSource = function() {
                const sourceSelect = document.getElementById('log-source-select');
                const prioritySelect = document.getElementById('log-priority-select');
                currentLogSource = sourceSelect.value;
                currentPriority = prioritySelect.value;
                const logsContentDiv = document.getElementById('logs-content');
                logsContentDiv.innerHTML = '<div class="text-slate-500 italic text-sm" id="loading-message">Loading logs...</div>';
                
                // Fetch initial logs
                fetch(`/api/recent-logs?source=${currentLogSource}&lines=10&priority=${currentPriority}`)
                    .then(response => response.json())
                    .then(data => {
                        const loadingMsg = document.getElementById('loading-message');
                        if (loadingMsg) loadingMsg.remove();
                        
                        if (data.logs && data.logs.length > 0) {
                            data.logs.forEach(log => {
                                logsContentDiv.appendChild(formatLogLine(log.message));
                            });
                            const logsContainer = document.getElementById('logs-container');
                            logsContainer.scrollTop = logsContainer.scrollHeight;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching initial logs:', error);
                        const loadingMsg = document.getElementById('loading-message');
                        if (loadingMsg) loadingMsg.remove();
                    });
                
                initializeSSE();
            };

            // Log Processing
            function formatLogLine(message) {
                const div = document.createElement('div');
                div.classList.add('log-line');

                if (message.includes('[ERROR]') || message.toLowerCase().includes('error:')) {
                    div.classList.add('error');
                    div.textContent = message.replace('[ERROR]', '').trim();
                } else if (message.includes('[WARNING]') || message.toLowerCase().includes('warn:')) {
                    div.classList.add('warning');
                    div.textContent = message.replace('[WARNING]', '').trim();
                } else if (message.includes('[INFO]')) {
                    div.classList.add('info');
                    div.textContent = message.replace('[INFO]', '').trim();
                } else {
                    div.classList.add('default');
                    div.textContent = message;
                }
                return div;
            }

            document.querySelectorAll('#logs-content .log-line').forEach(line => {
                const text = line.textContent;
                line.className = 'log-line';
                if (text.includes('[ERROR]')) line.classList.add('error');
                else if (text.includes('[WARNING]')) line.classList.add('warning');
                else if (text.includes('[INFO]')) line.classList.add('info');
                else line.classList.add('default');
                if (text.includes(']')) line.textContent = text.substring(text.indexOf(']') + 1).trim();
            });

            function initializeSSE() {
                if (eventSource) eventSource.close();
                const logsContentDiv = document.getElementById('logs-content');
                const logsContainer = document.getElementById('logs-container');

                const streamUrl = '/logs-stream?source=' + currentLogSource + '&priority=' + currentPriority;
                eventSource = new EventSource(streamUrl);

                eventSource.onmessage = function (event) {
                    try {
                        // Remove loading message if it still exists
                        const loadingMsg = document.getElementById('loading-message');
                        if (loadingMsg) loadingMsg.remove();
                        
                        const logMsg = JSON.parse(event.data);
                        const newLog = formatLogLine(logMsg.message);
                        logsContentDiv.appendChild(newLog);

                        // Limit the number of log lines to prevent memory issues
                        const maxLogs = 1000;
                        while (logsContentDiv.children.length > maxLogs) {
                            logsContentDiv.removeChild(logsContentDiv.firstChild);
                        }

                        const isAtBottom = logsContainer.scrollHeight - logsContainer.scrollTop <= logsContainer.clientHeight + 100;
                        if (isAtBottom) logsContainer.scrollTop = logsContainer.scrollHeight;
                    } catch (e) {
                        console.error('Error processing log:', e);
                    }
                };

                eventSource.onerror = () => {
                    eventSource.close();
                    setTimeout(initializeSSE, 5000);
                };
            }

            initializeSSE();

            const handleAction = (e) => {
                const button = e.target.closest('.action-button');
                if (!button || operationInProgress) return;

                e.preventDefault();
                const action = button.getAttribute('data-action');

                // Set operation in progress
                operationInProgress = true;

                const originalText = button.textContent;
                button.textContent = '...';
                button.disabled = true;

                // Disable all action buttons
                document.querySelectorAll('.action-button').forEach(btn => btn.disabled = true);

                fetch(`/api/${action}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status) {
                            // For restart, wait a bit longer before allowing button updates
                            if (action === 'restart') {
                                setTimeout(() => {
                                    operationInProgress = false;
                                    updateStatus();
                                }, 3000);
                            } else {
                                operationInProgress = false;
                                updateStatus();
                            }
                        } else {
                            alert('Action failed');
                            operationInProgress = false;
                            updateStatus();
                        }
                    })
                    .catch(err => {
                        alert('Error: ' + err);
                        operationInProgress = false;
                        updateStatus();
                    });
            };

            document.getElementById('action-buttons').addEventListener('click', handleAction);
            document.querySelector('.grid').addEventListener('click', handleAction);

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) { if (eventSource) eventSource.close(); }
                else { initializeSSE(); updateStatus(); }
            });

            const logsContainer = document.getElementById('logs-container');
            if (logsContainer) logsContainer.scrollTop = logsContainer.scrollHeight;
        });
    </script>
</div>
{{ end }}