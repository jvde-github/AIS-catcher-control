{{ define "control" }}
<div id="input-selection" class="p-6 bg-white rounded-lg shadow-md">
    <!-- Styles for Log Lines and Spinner -->
    <style>
        .log-line {
            white-space: pre-wrap;
            /* Preserve whitespace and wrap text */
            padding: 2px 0;
            font-family: monospace;
            font-size: 14px;
        }

        /* Style error logs in red */
        .log-line.error {
            color: #FF4C4C;
            /* Bright Red for errors */
            background-color: rgba(255, 76, 76, 0.1);
            border-left: 4px solid #FF4C4C;
            padding-left: 8px;
        }

        /* Style warning logs in orange */
        .log-line.warning {
            color: #FFA500;
            /* Orange for warnings */
            background-color: rgba(255, 165, 0, 0.1);
            border-left: 4px solid #FFA500;
            padding-left: 8px;
        }

        /* Style info logs in blue */
        .log-line.info {
            color: #1E90FF;
            /* Dodger Blue for info */
            background-color: rgba(30, 144, 255, 0.1);
            border-left: 4px solid #1E90FF;
            padding-left: 8px;
        }

        /* Spinner Styles */
        .spinner {
            border: 6px solid rgba(0, 0, 0, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden-spinner {
            display: none;
        }

        #output-container,
        #journalctl-container {
            scroll-behavior: smooth;
        }
    </style>

    <div class="bg-white rounded-lg shadow-md p-4 w-full mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="mb-4 md:mb-0">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Service Status</h2>
                <div class="flex items-center">
                    <span class="text-gray-700 mr-2">Status:</span>
                    <!-- Placeholder for dynamic status -->
                    <span id="service-status">
                        <!-- Initial placeholder text, will be updated by JavaScript -->
                        Checking status...
                    </span>
                </div>
            </div>
            <!-- Placeholder for action buttons -->
            <div id="action-buttons" class="flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-4 w-full mb-8">
        <h2 class="text-xl font-semibold mb-2 text-gray-800">Service Uptime</h2>
        <div class="flex items-center">
            <span class="text-gray-700 mr-2">Running for:</span>
            <!-- Placeholder for dynamic uptime -->
            <span id="service-uptime" class="text-gray-800 font-medium">Calculating uptime...</span>
        </div>
    </div>

    <!-- Service Configuration Section -->
    {{ if not .Docker }}
    <div class="bg-white rounded-lg shadow-md p-4 w-full mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            
            <div class="mb-4 md:mb-0">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Auto-Start Service</h2>
                <div class="flex items-center">
                    <span class="text-gray-700 mr-2">Enabled:</span>
                    {{if .ServiceEnabled}}
                    <span
                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        Yes
                    </span>
                    {{else}}
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                        No
                    </span>
                    {{end}}
                </div>
            </div>
            <div class="flex gap-2">
                {{if not .ServiceEnabled}}
                <a href="/service?action=enable"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 action-button">Enable</a>
                {{else}}
                <a href="/service?action=disable"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 action-button">Disable</a>
                {{end}}
            </div>
        </div>
    </div>
    {{ end }}

    <!-- Recent Logs Section -->
    <div class="mb-8 p-4">
        
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Log</h2>

        <!-- Output Logs (log.txt) -->
        <div class="bg-gray-900 text-gray-100 p-4 rounded-lg h-80 w-full overflow-y-auto mb-4" id="output-container">
            <div id="output-logs" class="text-sm leading-relaxed">
                {{if .LogTxtLogs}}
                {{range .LogTxtLogs}}<div class="log-line">{{.}}</div>
                {{end}}
                {{else}}
                <p class="text-gray-400">No logs available.</p>
                {{end}}
            </div>
        </div>

        {{ if not .Docker }}
        <!-- Journalctl Logs -->
        <h2 class="text-xl font-semibold mb-4 text-gray-800">System Log</h2>        
        <div class="bg-gray-900 text-gray-100 p-4 rounded-lg h-64 w-full overflow-y-auto" id="journalctl-container">
            <div id="journalctl-logs" class="text-sm leading-relaxed">
                {{if .Logs}}
                {{range .Logs}}<div class="log-line">{{.}}</div>
                {{end}}
                {{else}}
                <p class="text-gray-400">No logs available.</p>
                {{end}}
            </div>
        </div>
        {{ end }}
    </div>

    <!-- Action Spinner -->
    <div id="action-spinner" class="spinner hidden-spinner"></div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let eventSource = null;
            function updateStatus() {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => {
                        // Update status text
                        const statusSpan = document.getElementById('service-status');
                        let statusHTML = '';
                        if (data.status === 'active (running)') {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active (Running)</span>';
                        } else if (data.status === 'inactive (stopped)') {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive (Stopped)</span>';
                        } else if (data.status === 'failed') {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Failed</span>';
                        } else {
                            statusHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">' + data.status + '</span>';
                        }
                        statusSpan.innerHTML = statusHTML;

                        // Update uptime text
                        const uptimeSpan = document.getElementById('service-uptime');
                        uptimeSpan.textContent = data.uptime;

                        // Update action buttons based on status
                        const actionButtonsDiv = document.getElementById('action-buttons');
                        let buttonsHTML = '';
                        if (data.status === 'active (running)') {
                            buttonsHTML += `
                        <a href="/service?action=stop" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 action-button">Stop</a>
                        <a href="/service?action=restart" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 action-button">Restart</a>
                    `;
                        } else {
                            buttonsHTML += `
                        <a href="/service?action=start" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 action-button">Start</a>
                    `;
                        }
                        actionButtonsDiv.innerHTML = buttonsHTML;

                        // Reattach event listeners to action buttons
                        const actionButtons = document.querySelectorAll('.action-button');
                        const actionSpinner = document.getElementById('action-spinner');
                        actionButtons.forEach(button => {
                            button.addEventListener('click', function (e) {
                                e.preventDefault();
                                const href = this.getAttribute('href');
                                actionSpinner.classList.remove('hidden-spinner');

                                fetch(href)
                                    .then(response => {
                                        actionSpinner.classList.add('hidden-spinner');
                                        if (response.redirected) {
                                            window.location.href = response.url;
                                        }
                                    })
                                    .catch(error => {
                                        actionSpinner.classList.add('hidden-spinner');
                                        alert('An error occurred: ' + error);
                                    });
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                    });
            }

            updateStatus();
            setInterval(updateStatus, 2000);

            function initializeSSE() {
                if (eventSource) {
                    eventSource.close();
                }

                const outputLogsDiv = document.getElementById('output-logs');
                const journalctlLogsDiv = document.getElementById('journalctl-logs');
                const outputContainer = document.getElementById('output-container');
                const journalctlContainer = document.getElementById('journalctl-container');
                const actionSpinner = document.getElementById('action-spinner');
                eventSource = new EventSource('/logs-stream');

                eventSource.onmessage = function (event) {
                    try {
                        const logMsg = JSON.parse(event.data);
                        const source = logMsg.source;
                        const message = logMsg.message;

                        const newLog = document.createElement('div');
                        newLog.classList.add('log-line');

                        // Determine log level based on prefix in message
                        if (message.startsWith('[ERROR]')) {
                            newLog.classList.add('error');
                            newLog.textContent = message.substring(7).trim(); // Remove the prefix
                        } else if (message.startsWith('[WARNING]')) {
                            newLog.classList.add('warning');
                            newLog.textContent = message.substring(9).trim(); // Remove the prefix
                        } else if (message.startsWith('[INFO]')) {
                            newLog.classList.add('info');
                            newLog.textContent = message.substring(6).trim(); // Remove the prefix
                        } else {
                            // Default styling for unrecognized log levels
                            newLog.textContent = message;
                        }

                        // Append to the correct container based on source
                        if (source === "journalctl") {
                            journalctlLogsDiv.appendChild(newLog);
                            // Always scroll to the bottom
                            journalctlContainer.scrollTop = journalctlContainer.scrollHeight;
                        } else if (source === "log.txt") {
                            outputLogsDiv.appendChild(newLog);
                            // Always scroll to the bottom
                            outputContainer.scrollTop = outputContainer.scrollHeight;
                        }
                    } catch (e) {
                        console.error('Error processing log message:', e);
                    }
                };

                eventSource.onerror = function () {
                    console.error('Error with SSE connection');
                    eventSource.close();
                    setTimeout(initializeSSE, 5000);
                };
            }

            initializeSSE();

            const actionButtons = document.querySelectorAll('.action-button');
            const actionSpinner = document.getElementById('action-spinner');

            actionButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    actionSpinner.classList.remove('hidden-spinner');

                    fetch(href)
                        .then(response => {
                            actionSpinner.classList.add('hidden-spinner');
                            if (response.redirected) {
                                window.location.href = response.url;
                            }
                        })
                        .catch(error => {
                            actionSpinner.classList.add('hidden-spinner');
                            alert('An error occurred: ' + error);
                        });
                });
            });

            window.addEventListener('beforeunload', function () {
                if (eventSource) {
                    eventSource.close();
                }
            });

            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    if (eventSource) {
                        eventSource.close();
                    }
                } else {
                    initializeSSE();
                }
            });

            // Scroll to bottom on initial load
            const outputContainerInitial = document.getElementById('output-container');
            const journalctlContainerInitial = document.getElementById('journalctl-container');
            outputContainerInitial.scrollTop = outputContainerInitial.scrollHeight;
            journalctlContainerInitial.scrollTop = journalctlContainerInitial.scrollHeight;

            const logLines = document.querySelectorAll('#output-logs .log-line');
            logLines.forEach(function (line) {
                if (line.textContent.startsWith('[ERROR]')) {
                    line.classList.add('error');
                    line.textContent = line.textContent.substring(7).trim(); // Remove prefix
                } else if (line.textContent.startsWith('[WARNING]')) {
                    line.classList.add('warning');
                    line.textContent = line.textContent.substring(9).trim(); // Remove prefix
                } else if (line.textContent.startsWith('[INFO]')) {
                    line.classList.add('info');
                    line.textContent = line.textContent.substring(6).trim(); // Remove prefix
                }
                // You can add more conditions if there are other log levels
            });
        });
    </script>

</div>
{{ end }}