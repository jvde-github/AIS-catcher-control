{{ define "control" }}
<div class="p-2 sm:p-6 bg-white rounded-lg shadow-md">
    <!-- Styles for Log Lines -->
    <style>
        .log-line {
            white-space: pre-wrap;
            padding: 2px 0;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }

        .log-line.error {
            color: #FF4C4C;
            background-color: rgba(255, 76, 76, 0.1);
            border-left: 4px solid #FF4C4C;
            padding-left: 8px;
        }

        .log-line.warning {
            color: #FFA500;
            background-color: rgba(255, 165, 0, 0.1);
            border-left: 4px solid #FFA500;
            padding-left: 8px;
        }

        .log-line.info {
            color: #1E90FF;
            background-color: rgba(30, 144, 255, 0.1);
            border-left: 4px solid #1E90FF;
            padding-left: 8px;
        }

        #output-container,
        #journalctl-container {
            scroll-behavior: smooth;
            max-width: 100%;
            overflow-x: auto;
        }
    </style>

    <!-- Status Cards Grid - Updated for responsive layout -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <!-- Service Status Card -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border border-gray-200">
            <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-800">Service Status</h2>
            <div class="flex flex-col space-y-3 sm:space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm sm:text-base text-gray-600">Status:</span>
                    <span id="service-status" class="text-sm sm:text-base">Checking status...</span>
                </div>
                <div class="flex flex-wrap gap-2 justify-end" id="action-buttons"></div>
            </div>
        </div>

        <!-- Service Uptime Card -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border border-gray-200">
            <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-800">Service Uptime</h2>
            <div class="flex items-center justify-between">
                <span class="text-sm sm:text-base text-gray-600">Running for:</span>
                <span id="service-uptime" class="text-sm sm:text-base text-gray-800 font-medium">Calculating
                    uptime...</span>
            </div>
        </div>

        <!-- Auto-Start Service Card -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 border border-gray-200">
            <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-800">Auto-Start</h2>
            <div class="flex flex-col space-y-3 sm:space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm sm:text-base text-gray-600">Enabled:</span>
                    <div>
                        <span id="enabled-true"
                            class="hidden px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium rounded-full bg-gray-100 text-gray-800">Yes</span>
                        <span id="enabled-false"
                            class="hidden px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium rounded-full bg-gray-100 text-gray-800">No</span>
                    </div>
                </div>
                <div class="flex gap-2 justify-end">
                    <button id="enable-button" data-action="enable"
                        class="hidden px-3 sm:px-4 py-1 sm:py-2 text-sm bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition duration-200 action-button">Enable</button>
                    <button id="disable-button" data-action="disable"
                        class="hidden px-3 sm:px-4 py-1 sm:py-2 text-sm bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition duration-200 action-button">Disable</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rest of the template remains the same -->
    <!-- Logs Section -->
    <div class="space-y-4 sm:space-y-6">
        {{ if .Docker }}
        <div>
            <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-800">Log</h2>
            <div class="bg-gray-900 text-gray-100 p-3 sm:p-4 rounded-lg h-48 sm:h-64 overflow-y-auto"
                id="output-container">
                <div id="output-logs" class="text-xs sm:text-sm leading-relaxed break-all">
                    {{if .LogTxtLogs}}
                    {{range .LogTxtLogs}}<div class="log-line">{{.}}</div>{{end}}
                    {{else}}
                    <p class="text-gray-400">No logs available.</p>
                    {{end}}
                </div>
            </div>
        </div>
        {{ end }}

        {{ if not .Docker }}
        <div>
            <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-gray-800">System Log</h2>
            <div class="bg-gray-900 text-gray-100 p-3 sm:p-4 rounded-lg h-48 sm:h-64 overflow-y-auto"
                id="journalctl-container">
                <div id="journalctl-logs" class="text-xs sm:text-sm leading-relaxed break-all">
                    {{if .Logs}}
                    {{range .Logs}}<div class="log-line">{{.}}</div>{{end}}
                    {{else}}
                    <p class="text-gray-400">No logs available.</p>
                    {{end}}
                </div>
            </div>
        </div>
        {{ end }}
    </div>

    <script>

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.enabled) {
                        document.getElementById('enabled-true').classList.remove('hidden')
                        document.getElementById('enabled-false').classList.add('hidden')
                        document.getElementById('enable-button').classList.add('hidden')
                        document.getElementById('disable-button').classList.remove('hidden')
                    } else {
                        document.getElementById('enabled-true').classList.add('hidden')
                        document.getElementById('enabled-false').classList.remove('hidden')
                        document.getElementById('enable-button').classList.remove('hidden')
                        document.getElementById('disable-button').classList.add('hidden')
                    }

                    const statusSpan = document.getElementById('service-status');
                    let statusHTML = '';
                    if (data.status === 'active (running)') {
                        statusHTML = '<span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800">Active</span>';
                    } else if (data.status === 'inactive (stopped)') {
                        statusHTML = '<span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800">Inactive</span>';
                    } else if (data.status === 'failed') {
                        statusHTML = '<span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800">Failed</span>';
                    } else {
                        statusHTML = '<span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800">' + data.status + '</span>';
                    }
                    statusSpan.innerHTML = statusHTML;

                    const uptimeSpan = document.getElementById('service-uptime');
                    uptimeSpan.textContent = data.uptime;

                    const actionButtonsDiv = document.getElementById('action-buttons');
                    let buttonsHTML = '';
                    if (data.status === 'active (running)') {
                        buttonsHTML += `
                            <button data-action="stop" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition duration-200 action-button">Stop</button>
                            <button data-action="restart" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition duration-200 action-button">Restart</button>
                        `;
                    } else {
                        buttonsHTML += `
                            <button data-action="start" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition duration-200 action-button">Start</button>
                        `;
                    }
                    actionButtonsDiv.innerHTML = buttonsHTML;

                    const newActionButtons = actionButtonsDiv.querySelectorAll('.action-button');
                    newActionButtons.forEach(button => {
                        button.addEventListener('click', function (e) {
                            e.preventDefault();
                            const action = this.getAttribute('data-action');
                            if (!action) {
                                console.error('No data-action attribute found on button.');
                                return;
                            }

                            fetch(`/service?action=${action}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status) {
                                        updateStatus();
                                    } else {
                                        alert('Action failed.');
                                    }
                                })
                                .catch(error => {
                                    alert('An error occurred: ' + error);
                                });
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            let eventSource = null;


            updateStatus();
            setInterval(updateStatus, 3000);

            function initializeSSE() {
                if (eventSource) {
                    eventSource.close();
                }

                const outputLogsDiv = document.getElementById('output-logs');
                const journalctlLogsDiv = document.getElementById('journalctl-logs');
                const outputContainer = document.getElementById('output-container');
                const journalctlContainer = document.getElementById('journalctl-container');
                eventSource = new EventSource('/logs-stream');

                eventSource.onmessage = function (event) {
                    try {
                        const logMsg = JSON.parse(event.data);
                        const source = logMsg.source;
                        const message = logMsg.message;

                        const newLog = document.createElement('div');
                        newLog.classList.add('log-line');

                        // Determine log level based on prefix in message
                        if (message.startsWith('[ERROR]')) {
                            newLog.classList.add('error');
                            newLog.textContent = message.substring(7).trim(); // Remove the prefix
                        } else if (message.startsWith('[WARNING]')) {
                            newLog.classList.add('warning');
                            newLog.textContent = message.substring(9).trim(); // Remove the prefix
                        } else if (message.startsWith('[INFO]')) {
                            newLog.classList.add('info');
                            newLog.textContent = message.substring(6).trim(); // Remove the prefix
                        } else {
                            // Default styling for unrecognized log levels
                            newLog.textContent = message;
                        }

                        // Append to the correct container based on source
                        if (source === "journalctl") {
                            journalctlLogsDiv.appendChild(newLog);
                            // Always scroll to the bottom
                            journalctlContainer.scrollTop = journalctlContainer.scrollHeight;
                        } else if (source === "log.txt") {
                            outputLogsDiv.appendChild(newLog);
                            // Always scroll to the bottom
                            outputContainer.scrollTop = outputContainer.scrollHeight;
                        }
                    } catch (e) {
                        console.error('Error processing log message:', e);
                    }
                };

                eventSource.onerror = function () {
                    console.error('Error with SSE connection');
                    eventSource.close();
                    setTimeout(initializeSSE, 5000);
                };
            }

            initializeSSE();

            const actionButtons = document.querySelectorAll('.action-button');

            actionButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const action = this.getAttribute('data-action');
                    if (!action) {
                        console.error('No data-action attribute found on button.');
                        return;
                    }

                    fetch(`/service?action=${action}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status) {
                                updateStatus();
                            } else {
                                alert('Action failed.');
                            }
                        })
                        .catch(error => {
                            alert('An error occurred: ' + error);
                        });
                });
            });

            window.addEventListener('beforeunload', function () {
                if (eventSource) {
                    eventSource.close();
                }
            });

            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    if (eventSource) {
                        eventSource.close();
                    }
                } else {
                    initializeSSE();
                }
            });

            // Scroll to bottom on initial load
            const outputContainerInitial = document.getElementById('output-container');
            const journalctlContainerInitial = document.getElementById('journalctl-container');
            if (outputContainerInitial)
                outputContainerInitial.scrollTop = outputContainerInitial.scrollHeight;

            if (journalctlContainerInitial)
                journalctlContainerInitial.scrollTop = journalctlContainerInitial.scrollHeight;

            const logLines = document.querySelectorAll('#output-logs .log-line');
            logLines.forEach(function (line) {
                if (line.textContent.startsWith('[ERROR]')) {
                    line.classList.add('error');
                    line.textContent = line.textContent.substring(7).trim(); // Remove prefix
                } else if (line.textContent.startsWith('[WARNING]')) {
                    line.classList.add('warning');
                    line.textContent = line.textContent.substring(9).trim(); // Remove prefix
                } else if (line.textContent.startsWith('[INFO]')) {
                    line.classList.add('info');
                    line.textContent = line.textContent.substring(6).trim(); // Remove prefix
                }
                // You can add more conditions if there are other log levels
            });
        });
    </script>
</div>
{{ end }}